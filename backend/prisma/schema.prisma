generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String       @id @default(cuid())
  email       String       @unique
  password    String
  name        String
  role        Role         @default(USER)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  avatar      String?
  reports     Report[]
  validations Validation[]

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Client {
  id          String       @id @default(cuid())
  name        String
  email       String?
  phone       String?
  address     String?
  street      String?
  neighborhood String?
  city        String?
  state       String?
  complement  String?
  cnpj        String?     @unique
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  reports     Report[]
  validations Validation[]
  equipments  ClientEquipment[]

  @@index([name])
  @@index([email])
  @@index([cnpj])
  @@index([createdAt])
  @@map("clients")
}

model SensorType {
  id          String   @id @default(cuid())
  name        String
  description String?
  dataConfig  Json
  sensors     Sensor[]

  @@map("sensor_types")
}

model Sensor {
  id              String           @id @default(cuid())
  serialNumber    String           @unique
  model           String
  typeId          String
  calibrationDate DateTime?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  sensorData      SensorData[]
  type            SensorType       @relation(fields: [typeId], references: [id])
  suitcaseSensors SuitcaseSensor[]

  @@index([typeId])
  @@index([serialNumber])
  @@index([model])
  @@index([createdAt])
  @@map("sensors")
}

model Suitcase {
  id          String           @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
  sensors     SuitcaseSensor[]
  validations Validation[]

  @@map("suitcases")
}

model SuitcaseSensor {
  id         String   @id @default(cuid())
  suitcaseId String
  sensorId   String
  position   Int?
  sensor     Sensor   @relation(fields: [sensorId], references: [id])
  suitcase   Suitcase @relation(fields: [suitcaseId], references: [id])

  @@unique([suitcaseId, sensorId])
  @@map("suitcase_sensors")
}

model SensorData {
  id           String      @id @default(cuid())
  sensorId     String
  timestamp    DateTime
  temperature  Float
  humidity     Float?
  fileName     String
  rowNumber    Int
  createdAt    DateTime    @default(now())
  validationId String?
  sensor       Sensor      @relation(fields: [sensorId], references: [id])
  validation   Validation? @relation(fields: [validationId], references: [id])

  @@index([sensorId])
  @@index([timestamp])
  @@index([validationId])
  @@index([fileName])
  @@index([sensorId, timestamp])
  @@index([validationId, timestamp])
  @@map("sensor_data")
}

model Validation {
  id             String       @id @default(cuid())
  suitcaseId     String?
  clientId       String
  userId         String
  name           String
  description    String?
  minTemperature Float
  maxTemperature Float
  minHumidity    Float?
  maxHumidity    Float?
  isApproved     Boolean?
  statistics     Json?
  validationNumber String?
  equipmentId     String?
  equipmentSerial String?
  equipmentTag    String?
  equipmentPatrimony String?
  startAt        DateTime?
  endAt          DateTime?
  hiddenSensorIds String[]     @default([])
  createdAt      DateTime     @default(now())
  updatedAt      DateTime     @updatedAt
  reports        Report[]
  sensorData     SensorData[]
  cycles         ValidationCycle[]
  importedItems  ValidationImportItem[]
  client         Client       @relation(fields: [clientId], references: [id])
  suitcase       Suitcase?    @relation(fields: [suitcaseId], references: [id])
  user           User         @relation(fields: [userId], references: [id])
  equipment      ClientEquipment? @relation(fields: [equipmentId], references: [id])

  @@index([clientId])
  @@index([userId])
  @@index([suitcaseId])
  @@index([isApproved])
  @@index([validationNumber])
  @@index([createdAt])
  @@index([clientId, createdAt])
  @@index([userId, createdAt])
  @@map("validations")
}

model EquipmentItemType {
  id          String            @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  models      EquipmentModel[]
  equipments  ClientEquipment[]

  @@map("equipment_item_types")
}

model EquipmentBrand {
  id          String            @id @default(cuid())
  name        String            @unique
  description String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  models      EquipmentModel[]
  equipments  ClientEquipment[]

  @@map("equipment_brands")
}

model EquipmentModel {
  id          String            @id @default(cuid())
  name        String
  brandId     String
  typeId      String
  description String?
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  brand       EquipmentBrand    @relation(fields: [brandId], references: [id])
  type        EquipmentItemType @relation(fields: [typeId], references: [id])
  equipments  ClientEquipment[]

  @@unique([brandId, name])
  @@map("equipment_models")
}

model ClientEquipment {
  id                String            @id @default(cuid())
  clientId          String
  equipmentTypeId   String
  brandId           String
  modelId           String
  serialNumber      String
  assetNumber       String?
  tag               String?
  acceptanceMinTemp Float?
  acceptanceMaxTemp Float?
  acceptanceMinHum  Float?
  acceptanceMaxHum  Float?
  acceptanceNotes   String?
  createdAt         DateTime          @default(now())
  updatedAt         DateTime          @updatedAt
  client            Client            @relation(fields: [clientId], references: [id])
  equipmentType     EquipmentItemType @relation(fields: [equipmentTypeId], references: [id])
  brand             EquipmentBrand    @relation(fields: [brandId], references: [id])
  model             EquipmentModel    @relation(fields: [modelId], references: [id])
  validations       Validation[]

  @@index([clientId])
  @@index([serialNumber])
  @@map("client_equipments")
}

model ValidationCycle {
  id                    String              @id @default(cuid())
  validationId          String
  name                  String
  cycleType             ValidationCycleType @default(NORMAL)
  startAt               DateTime
  endAt                 DateTime
  uninterruptedDuration Int?
  notes                 String?
  createdAt             DateTime            @default(now())
  updatedAt             DateTime            @updatedAt
  validation            Validation          @relation(fields: [validationId], references: [id], onDelete: Cascade)
  importedItems         ValidationImportItem[]

  @@index([validationId])
  @@map("validation_cycles")
}

model ValidationImportItem {
  id           String           @id @default(cuid())
  validationId String
  cycleId      String?
  timestamp    DateTime
  temperature  Float
  humidity     Float?
  fileName     String?
  rowNumber    Int?
  note         String?
  isVisible    Boolean          @default(true)
  createdAt    DateTime         @default(now())
  updatedAt    DateTime         @updatedAt
  validation   Validation       @relation(fields: [validationId], references: [id], onDelete: Cascade)
  cycle        ValidationCycle? @relation(fields: [cycleId], references: [id], onDelete: Cascade)

  @@index([validationId])
  @@map("validation_import_items")
}

model ReportTemplate {
  id           String   @id @default(cuid())
  name         String
  description  String?
  templatePath String
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  reports      Report[]

  @@map("report_templates")
}

model Report {
  id                String               @id @default(cuid())
  validationId      String
  templateId        String
  userId            String
  clientId          String
  name              String
  status            ReportStatus         @default(DRAFT)
  pdfPath           String?
  digitalSignature  String?
  signedAt          DateTime?
  signedBy          String?
  certificateInfo   Json?
  createdAt         DateTime             @default(now())
  updatedAt         DateTime             @updatedAt
  client            Client               @relation(fields: [clientId], references: [id])
  template          ReportTemplate       @relation(fields: [templateId], references: [id])
  user              User                 @relation(fields: [userId], references: [id])
  validation        Validation           @relation(fields: [validationId], references: [id])
  sharedLinks       ReportSharedLink[]

  @@index([clientId])
  @@index([userId])
  @@index([validationId])
  @@index([templateId])
  @@index([status])
  @@index([createdAt])
  @@index([clientId, status])
  @@index([userId, createdAt])
  @@index([signedAt])
  @@map("reports")
}

model ReportSharedLink {
  id          String    @id @default(cuid())
  reportId    String
  token       String    @unique
  expiresAt   DateTime
  maxAccess   Int?
  accessCount Int       @default(0)
  password    String?
  allowedIPs  String[]
  createdBy   String
  createdAt   DateTime  @default(now())
  lastAccess  DateTime?
  isActive    Boolean   @default(true)
  report      Report    @relation(fields: [reportId], references: [id], onDelete: Cascade)
  accesses    SharedLinkAccess[]

  @@index([token])
  @@index([reportId])
  @@index([expiresAt])
  @@index([isActive])
  @@index([createdBy])
  @@map("report_shared_links")
}

model SharedLinkAccess {
  id        String           @id @default(cuid())
  linkId    String
  ip        String
  userAgent String?
  timestamp DateTime         @default(now())
  success   Boolean
  link      ReportSharedLink @relation(fields: [linkId], references: [id], onDelete: Cascade)

  @@index([linkId])
  @@index([timestamp])
  @@map("shared_link_accesses")
}

model EditorTemplate {
  id           String                  @id @default(cuid())
  name         String
  description  String?
  category     String                  @default("default")
  elements     Json
  globalStyles Json
  pages        Json?
  pageSettings Json?
  tags         String[]
  thumbnail    String?
  isPublic     Boolean                 @default(false)
  createdBy    String
  version      Int                     @default(1)
  createdAt    DateTime                @default(now())
  updatedAt    DateTime                @updatedAt
  revision     Int                     @default(0)
  versions     EditorTemplateVersion[]

  @@index([createdBy])
  @@index([category])
  @@index([isPublic])
  @@index([createdAt])
  @@index([updatedAt])
  @@index([createdBy, isPublic])
  @@index([category, isPublic])
  @@map("editor_templates")
}

model EditorTemplateVersion {
  id           String         @id @default(cuid())
  templateId   String
  version      Int
  name         String
  description  String?
  elements     Json
  globalStyles Json
  pages        Json?
  pageSettings Json?
  changeLog    String?
  createdBy    String
  createdAt    DateTime       @default(now())
  template     EditorTemplate @relation(fields: [templateId], references: [id], onDelete: Cascade)

  @@unique([templateId, version])
  @@index([templateId])
  @@index([version])
  @@index([createdAt])
  @@index([templateId, version])
  @@map("editor_template_versions")
}

model AuditLog {
  id           String   @id @default(cuid())
  action       String
  resource     String
  resourceId   String?
  userId       String?
  userEmail    String?
  ip           String?
  userAgent    String?
  oldValues    String?
  newValues    String?
  metadata     String?
  success      Boolean
  errorMessage String?
  timestamp    DateTime @default(now())

  @@index([userId])
  @@index([resource])
  @@index([action])
  @@index([timestamp])
  @@map("audit_logs")
}

enum Role {
  USER
  ADMIN
}

enum ReportStatus {
  DRAFT
  VALIDATED
  FINALIZED
}

enum ValidationCycleType {
  EMPTY
  FULL
  OPEN_DOOR
  POWER_OUTAGE
  NORMAL
}
