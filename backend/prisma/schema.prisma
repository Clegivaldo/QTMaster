// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  name      String
  role      Role     @default(USER)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reports     Report[]
  validations Validation[]

  @@index([email])
  @@index([role])
  @@index([createdAt])
  @@map("users")
}

model Client {
  id        String   @id @default(cuid())
  name      String
  email     String?
  phone     String?
  address   String?
  cnpj      String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  reports     Report[]
  validations Validation[]

  @@index([name])
  @@index([email])
  @@index([cnpj])
  @@index([createdAt])
  @@map("clients")
}

model SensorType {
  id          String @id @default(cuid())
  name        String
  description String?

  // Configurações específicas para parsing dos arquivos
  dataConfig Json // Posições das colunas, formatos, etc.

  sensors Sensor[]

  @@map("sensor_types")
}

model Sensor {
  id              String    @id @default(cuid())
  serialNumber    String    @unique
  model           String
  typeId          String
  calibrationDate DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  type            SensorType       @relation(fields: [typeId], references: [id])
  suitcaseSensors SuitcaseSensor[]
  sensorData      SensorData[]

  @@index([typeId])
  @@index([serialNumber])
  @@index([model])
  @@index([createdAt])
  @@map("sensors")
}

model Suitcase {
  id          String   @id @default(cuid())
  name        String
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  sensors     SuitcaseSensor[]
  validations Validation[]

  @@map("suitcases")
}

model SuitcaseSensor {
  id         String @id @default(cuid())
  suitcaseId String
  sensorId   String
  position   Int? // Posição física na maleta

  suitcase Suitcase @relation(fields: [suitcaseId], references: [id])
  sensor   Sensor   @relation(fields: [sensorId], references: [id])

  @@unique([suitcaseId, sensorId])
  @@map("suitcase_sensors")
}

model SensorData {
  id           String   @id @default(cuid())
  sensorId     String
  timestamp    DateTime
  temperature  Float
  humidity     Float?
  fileName     String // Arquivo de origem
  rowNumber    Int // Linha no arquivo original
  createdAt    DateTime @default(now())
  validationId String?

  sensor     Sensor      @relation(fields: [sensorId], references: [id])
  validation Validation? @relation(fields: [validationId], references: [id])

  @@index([sensorId])
  @@index([timestamp])
  @@index([validationId])
  @@index([fileName])
  @@index([sensorId, timestamp])
  @@index([validationId, timestamp])
  @@map("sensor_data")
}

model Validation {
  id          String   @id @default(cuid())
  suitcaseId  String
  clientId    String
  userId      String
  name        String
  description String?

  // Parâmetros de validação
  minTemperature Float
  maxTemperature Float
  minHumidity    Float?
  maxHumidity    Float?

  // Resultados
  isApproved Boolean?
  statistics Json? // Estatísticas calculadas

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  suitcase   Suitcase     @relation(fields: [suitcaseId], references: [id])
  client     Client       @relation(fields: [clientId], references: [id])
  user       User         @relation(fields: [userId], references: [id])
  sensorData SensorData[]
  reports    Report[]

  @@index([clientId])
  @@index([userId])
  @@index([suitcaseId])
  @@index([isApproved])
  @@index([createdAt])
  @@index([clientId, createdAt])
  @@index([userId, createdAt])
  @@map("validations")
}

model ReportTemplate {
  id           String   @id @default(cuid())
  name         String
  description  String?
  templatePath String // Caminho para o arquivo FastReport
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  reports Report[]

  @@map("report_templates")
}

model Report {
  id           String       @id @default(cuid())
  validationId String
  templateId   String
  userId       String
  clientId     String
  name         String
  status       ReportStatus @default(DRAFT)
  pdfPath      String?
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  validation Validation     @relation(fields: [validationId], references: [id])
  template   ReportTemplate @relation(fields: [templateId], references: [id])
  user       User           @relation(fields: [userId], references: [id])
  client     Client         @relation(fields: [clientId], references: [id])

  @@index([clientId])
  @@index([userId])
  @@index([validationId])
  @@index([templateId])
  @@index([status])
  @@index([createdAt])
  @@index([clientId, status])
  @@index([userId, createdAt])
  @@map("reports")
}

enum Role {
  USER
  ADMIN
}

model AuditLog {
  id           String   @id @default(cuid())
  action       String   // Action performed (CREATE, UPDATE, DELETE, LOGIN, etc.)
  resource     String   // Resource affected (user, client, sensor, etc.)
  resourceId   String?  // ID of the affected resource
  userId       String?  // User who performed the action
  userEmail    String?  // Email of the user who performed the action
  ip           String?  // IP address of the request
  userAgent    String?  // User agent of the request
  oldValues    String?  // JSON string of old values (for updates/deletes)
  newValues    String?  // JSON string of new values (for creates/updates)
  metadata     String?  // Additional metadata as JSON string
  success      Boolean  // Whether the action was successful
  errorMessage String?  // Error message if action failed
  timestamp    DateTime @default(now())

  @@index([userId])
  @@index([resource])
  @@index([action])
  @@index([timestamp])
  @@map("audit_logs")
}

enum ReportStatus {
  DRAFT
  VALIDATED
  FINALIZED
}